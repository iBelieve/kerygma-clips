name: Preview Deploy

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: false

env:
  DOKKU_HOST: dev.mspencer.io
  APP_NAME_PREFIX: kerygma
  BASE_DOMAIN: mspencer.io

jobs:
  deploy-preview:
    name: Deploy to Preview Environment
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action != 'closed'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          version: latest
          tags: tag:ci
          ping: ${{ env.DOKKU_HOST }}

      - name: Deploy preview
        uses: ibelieve/dokku-preview-action@v1
        with:
          action: deploy
          dokku-host: ${{ env.DOKKU_HOST }}
          app-name-prefix: ${{ env.APP_NAME_PREFIX }}
          base-domain: ${{ env.BASE_DOMAIN }}
          release-script: |
            cp /app/prod-storage/database.sqlite /app/storage/app/database.sqlite
            cp -r /app/prod-storage/private/. /app/storage/app/private/
            cp -r /app/prod-storage/public/. /app/storage/app/public/
            php artisan migrate --force
            php artisan optimize:clear
            php artisan optimize
          storage-mounts: |
            {STORAGE_DIR}:/app/storage
            /var/lib/dokku/data/storage/kerygma/app/:/app/prod-storage:ro
            /data/syncthing/mluther-videos/Sermons:/app/sermon-videos:ro
            /var/lib/dokku/data/storage/hf-cache:/app/hf-cache
          env-vars: |
            SERMON_VIDEOS_DIR=/app/sermon-videos
            HF_HOME=/app/hf-cache
            TORCH_FORCE_NO_WEIGHTS_ONLY_LOAD=true
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            BROADCAST_CONNECTION=reverb
            REVERB_APP_ID=my-app-id
            REVERB_APP_KEY=my-app-key
            REVERB_APP_SECRET=my-app-secret
            REVERB_HOST=localhost
            REVERB_PORT=8080
            REVERB_SCHEME=http
          docker-build-args: |
            VITE_REVERB_APP_KEY=my-app-key
          process-scaling: |
            reverb=1
            worker=1
            transcription=1
            video-processing=1

  destroy-preview:
    name: Destroy Preview Environment
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository && github.event.action == 'closed'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          version: latest
          tags: tag:ci
          ping: ${{ env.DOKKU_HOST }}

      - name: Destroy preview
        uses: ibelieve/dokku-preview-action@v1
        with:
          action: destroy
          dokku-host: ${{ env.DOKKU_HOST }}
          app-name-prefix: ${{ env.APP_NAME_PREFIX }}
